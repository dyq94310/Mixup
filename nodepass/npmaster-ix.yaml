# ==========================================
# 1. Deployment: 核心应用 (使用 hostNetwork)
# ==========================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: npmaster-ix
  namespace: default
  labels:
    app: npmaster-ix
spec:
  replicas: 1
  # ⚠️ 关键：hostNetwork 模式下防止端口占用的死锁，必须设为 Recreate
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: npmaster-ix
  template:
    metadata:
      labels:
        app: npmaster-ix
    spec:
      # === 核心配置：开启 Host 网络 ===
      # 这允许 npmaster 动态监听宿主机的任意端口，就像 docker network_mode: host
      hostNetwork: true
      # 配合 hostNetwork 使用，确保 DNS 解析正常
      dnsPolicy: ClusterFirstWithHostNet

      # 建议固定节点，这样你就知道端口开在哪个 IP 上了
      nodeSelector:
        kubernetes.io/hostname: ix-20

      containers:
        - name: npmaster
          image: ghcr.io/yosebyte/nodepass:latest
          # 启动命令
          args:
            - "master://0.0.0.0:9090?log=info&tls=0"
          
          # 虽然用了 hostNetwork，声明端口是个好习惯（仅作文档作用）
          ports:
            - containerPort: 9090
              name: web-api

          env:
            - name: TZ
              value: "Asia/Shanghai"
          
          volumeMounts:
            - name: data
              mountPath: /gob

      volumes:
        - name: data
          hostPath:
            # ⚠️ 请确认宿主机路径
            path: /opt/k3s-data/nodepass-master
            type: DirectoryOrCreate

---
# ==========================================
# 2. Service: 连接 Ingress 和 Pod
# ==========================================
apiVersion: v1
kind: Service
metadata:
  name: npmaster-ix-svc
  namespace: default
spec:
  selector:
    app: npmaster-ix
  ports:
    - protocol: TCP
      name: web
      port: 80       # Service 暴露给 Ingress 的端口
      targetPort: 9090 # Pod 实际监听的端口
  # 即使是 hostNetwork 的 Pod，ClusterIP Service 依然能通过 Label 找到它
  type: ClusterIP

---
# ==========================================
# 3. Ingress: 管理面板的域名入口 (HTTPS)
# ==========================================
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: npmaster-ingress
  namespace: default
  # 保持简洁，不要多余的 annotations
spec:
  tls:
    - hosts:
        - npix.groovydeng.eu.org
      # 复用你现有的泛域名证书 Secret
      secretName: cf-tls

  rules:
    - host: npix.groovydeng.eu.org
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: npmaster-ix-svc
                port:
                  number: 80